from collections.abc import AsyncGenerator
from contextlib import asynccontextmanager

from fastapi import FastAPI

{% if database %}
from {{ project_slug }}.connection import Base, database
{% endif %}

{% if framework == 'fastapi' %}

@asynccontextmanager
async def lifespan(app: FastAPI) -> AsyncGenerator[None]:
{% if database %}
	async with database.engine.begin() as conn:
		# run_sync executes the given function in a sync context using the connection
		await conn.run_sync(Base.metadata.create_all)
	{% endif %}
	yield

{% endif %}
