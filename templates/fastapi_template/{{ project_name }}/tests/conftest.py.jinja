import asyncio
from typing import AsyncGenerator

import pytest
from httpx import AsyncClient
from sqlalchemy.ext.asyncio import AsyncSession

from {{ project_slug }}.api.application import app
{% if database %}
from {{ project_slug }}.connection import database
{% endif %}


@pytest.fixture(scope="session")
def event_loop():
	"""Create an instance of the default event loop for the test session."""
	loop = asyncio.get_event_loop_policy().new_event_loop()
	yield loop
	loop.close()


@pytest.fixture(scope="session")
async def client() -> AsyncGenerator[AsyncClient, None]:
	"""Create an async HTTP client for testing the FastAPI app."""
	async with AsyncClient(app=app, base_url="http://testserver") as client:
		yield client


{% if database %}
@pytest.fixture(scope="function")
async def db_session() -> AsyncGenerator[AsyncSession, None]:
	"""Create a database session for testing."""
	async for session in database.get_db():
		try:
			# Clear any existing data
			# You can add table cleanup here if needed
			yield session
			await session.rollback()  # Rollback changes after test
		except Exception:
			await session.rollback()
			raise
{% endif %}
