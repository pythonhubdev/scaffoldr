services:
  {{project_name}}-backend:
        build:
            context: ..
            dockerfile: .devcontainer/Dockerfile
            target: development
        volumes:
            - ../src:/app/src
            - ../pyproject.toml:/app/pyproject.toml
            - ../uv.lock:/app/uv.lock
        environment:
            - VALKEY_HOST=valkey
            - PYTHONUNBUFFERED=1
            - PYTHONPATH=/app/src
            - ENVIRONMENT=development
            - PIPER_HOST=piper
        ports:
            - "8443:8000"  # Changed: Use 8443 for HTTPS externally, map to 8000 internally
        command: [ "{{ project_slug }}", "--host", "0.0.0.0", "--port", "8000" ]
        healthcheck:
            test: [ "CMD", "curl", "-k", "-f", "https://localhost:8000/api" ]  # Updated: Use HTTPS with -k flag for self-signed cert
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        restart: unless-stopped
